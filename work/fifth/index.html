<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrapper">
        <div class="contents">
          <p class="title">Frameworks</p>
          <div class="select-wrapper">
            <select class="select">
              <option value="all">All</option>
            </select>
          </div>
          <ul class="list"></ul>
        </div>
      </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
      // 今回やるのはソート機能です。
      // selectボックスをクリックして言語を選び、その言語と関係のあるリストだけが表示されるプログラムです。
      // [処理の流れ]
      // ・セレクトボックスをクリックする。
      // ・セレクトボックスのvalueとliのdata-category-typeが一致しているものをだけ表示させる。
      // ・Allを選択した場合のみ全てのliを表示させる。
      // [使うメソッド]
      // .show() 要素を表示させる
      // .hide() 要素を隠す
      // .val() 要素のvalueを取得
      // .data('') DOM要素にあるdata-~を取得できる
      // .change() セレクトボックスの値の変更をキャッチする関数
      // $().each() DOM要素を1つずつループ処理をする（ループ内で$(this)を使うと要素がひとつずつ取得できる）
      // ---- Contorl ----
      function Frameworks() {
        this.$select = $('.select');
        this.$list = $('.list');
        this.categories;
        this.frameworks;
        this.init();
      }

      Frameworks.prototype.init = function() {
        this.fetch().then(function(data) {
          this.categories = data.categories;
          this.frameworks = data.frameworks;
          this.renderCategories(this.categories);
          this.renderFrameworks(this.frameworks);
          this.bind();
        }.bind(this));
      };

      Frameworks.prototype.bind = function() {
        this.$select.on('change', this.changeHandler.bind(this));
      }

      Frameworks.prototype.changeHandler = function(event) {
        var selectedVal = this.$select.val();
        var list = selectedVal === 'all' ? this.frameworks : this.filterFrameworks(selectedVal);
        this.renderFrameworks(list);
      }

      Frameworks.prototype.filterFrameworks = function (category) {
        return this.frameworks.filter(function (item) {
          return category === item.categoryType;
        });
      }

      // ---- Model ----
      Frameworks.prototype.fetch = function() {
        var dfd = $.Deferred();
        $.ajax({
          url: './data.json'
        })
        .done(function(data) {
          dfd.resolve(data)
        })
        return dfd.promise();
      }

      // ---- View ----
      Frameworks.prototype.renderCategories = function(categoires) {
        this.$select.append(this.getSelectTemplate(categoires));
      }
      Frameworks.prototype.getSelectTemplate = function(array) {
        return array.map(function(item) {
          return ('<option value="'+ item.categoryType +'">' + 
            item.categoryName + '</option>');
        }).join('');
      }

      Frameworks.prototype.renderFrameworks = function(frameworks) {
        this.$list.html(this.getFrameworksTemplate(frameworks));
      }
      Frameworks.prototype.getFrameworksTemplate = function(array) {
        return array
          .map(function(item){
            return (
              '<li>' +
              '<a href="' + item.frameworkURL + '" class="article">' +
              '<i class="article-icon is-' + item.frameworkType + '"></i>' +
              '<p class="article-name">' + item.frameworkName + '</p>' +
              '</a>' +
              '</li>'
              );
          })
          .join('');
      }


      $(function() {
        var frameworks = new Frameworks();
      });
    </script>
  </body>
</html>
